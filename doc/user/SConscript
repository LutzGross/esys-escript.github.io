
########################################################
#
# Copyright (c) 2003-2008 by University of Queensland
# Earth Systems Science Computational Center (ESSCC)
# http://www.uq.edu.au/esscc
#
# Primary Business: Queensland, Australia
# Licensed under the Open Software License version 3.0
# http://www.opensource.org/licenses/osl-3.0.php
#
########################################################


import os
Import('*')

local_env = clone_env(env)

latexmode='-interaction=nonstopmode'

tex_dir = local_env.Dir('.').srcnode().abspath
tex= [ env.File(x) for x in os.listdir(tex_dir) if not x.startswith('.') and not os.path.isdir(tex_dir+os.path.sep+x) and os.path.splitext(x)[1] in ['.tex', '.bib', '.sty', '.cfg', '.cls'] ] + \
     [ env.File('figures'+os.path.sep+x) for x in os.listdir(tex_dir+os.path.sep+'figures') if not x.startswith('.') ]

# We would like any figures in .eps to be converted into .pdfs

figs=[ os.path.splitext(x)[0] for x in os.listdir(tex_dir+os.path.sep+'figures') if not x.startswith('.') and os.path.splitext(x)[1] in ['.eps']]


latexcmd="pdflatex %s \\\\newcommand{\\\\RepVersion}{`svnversion`\\\\xspace}\\\\input{guide.tex}"%latexmode

env.Command('guide.pdf',tex,
            [ "epstopdf "+os.path.join('figures',name+".eps")+" -o "\
	      +os.path.join('figures',name+".pdf") for name in figs ]+ \
	    [ latexcmd,  \
              "bibtex guide",                  \
              "makeindex guide",               \
              latexcmd,      \
              latexcmd],      \
            chdir=tex_dir)

tmp=local_env.InstallAs(target=env['prefix']+'/release/doc/user/guide.pdf', source='guide.pdf')

env.Alias('guide_pdf', tmp)


#env.Alias('guide_pdf', env['prefix']+'/release/doc/user/guide.pdf')
#env.Alias('guide_pdf', tmp)


#env.Command(env['prefix']+'/release/doc/user/guide.pdf',tex,
            #[ mytest(), "latex %s guide.tex"%latexmode,  \
              #"bibtex guide",                  \
              #"makeindex guide",               \
              #"latex %s guide"%latexmode,      \
              #"latex %s guide"%latexmode,      \
              #"dvipdf guide.dvi %s"%env['prefix']+'/release/doc/user/guide.pdf' ],
            #chdir=tex_dir)
#env.Alias('guide_pdf', env['prefix']+'/release/doc/user/guide.pdf')


env.Command(env['prefix']+'/release/doc/user/html/index.htm',tex,			      \
		        ["latex2html -top_navigation                                  \
                        -bottom_navigation                                            \
                        -index_in_navigation                                          \
                        -contents_in_navigation                                       \
                        -next_page_in_navigation                                      \
                        -previous_page_in_navigation                                  \
                        -title \"esys users guide\"                                   \
                        -noshow_section_numbers                                       \
                        -dir \"../../release/doc/user/html\" -mkdir		      \
                        -address \"esys@esscc.uq.edu.au\"                             \
                        -antialias_text -antialias -transparent                       \
                        -noshort_extn                                                 \
                        -up_url \"http://www.access.edu.au/escript\",		      \
			-up_title \"escript\" guide.tex"], chdir=tex_dir)
env.Alias('guide_html', env['prefix']+'/release/doc/user/html/index.htm')

