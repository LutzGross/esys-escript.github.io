
########################################################
#
# Copyright (c) 2003-2010 by University of Queensland
# Earth Systems Science Computational Center (ESSCC)
# http://www.uq.edu.au/esscc
#
# Primary Business: Queensland, Australia
# Licensed under the Open Software License version 3.0
# http://www.opensource.org/licenses/osl-3.0.php
#
########################################################

import os
Import('*')
local_env = env.Clone()

latexmode='-interaction=nonstopmode'

tex_dir = local_env.Dir('.').srcnode().abspath
dir_cmd = "cd "+tex_dir+" && "

tex = [ env.File(x) for x in os.listdir(tex_dir) if not x.startswith('.') and not os.path.isdir(tex_dir+os.path.sep+x) and os.path.splitext(x)[1] in ['.tex', '.bib', '.sty', '.cfg', '.cls'] ] + \
     [ env.File('figures'+os.path.sep+x) for x in os.listdir(tex_dir+os.path.sep+'figures') if not x.startswith('.') ]

# We would like any figures in .eps to be converted into .pdf
#epsfigs=[ env.File('figures'+os.path.sep+x) for x in os.listdir(tex_dir+os.path.sep+'figures') if not x.startswith('.') and x.endswith('.eps') ]

epsfigs=[ os.path.join(tex_dir,'figures',x) for x in os.listdir(tex_dir+os.path.sep+'figures') if not x.startswith('.') and x.endswith('.eps') ]

#figs=[ os.path.join('figures',os.path.splitext(x)[0]+'.pdf') for x in os.listdir(tex_dir+os.path.sep+'figures') if not x.startswith('.') and os.path.splitext(x)[1] in ['.eps']]

figtarget=local_env.EpsToPDF(source=epsfigs,chdir=tex_dir)

latexcmd=dir_cmd+"pdflatex %s \\\\newcommand{\\\\RepVersion}{`svnversion`\\\\xspace}\\\\input{guide.tex}"%latexmode

local_env.Command(env['prefix']+'/doc/user/guide.pdf',[tex, figtarget], \
            [ latexcmd, \
              dir_cmd+"bibtex guide", \
              dir_cmd+"makeindex guide", \
              latexcmd, \
              latexcmd] \
)

tmp=local_env.InstallAs(target=env['prefix']+'/release/doc/user/guide.pdf', source=env['prefix']+'/doc/user/guide.pdf')

env.Alias('guide_pdf', tmp)

#env.Alias('guide_pdf', env['prefix']+'/release/doc/user/guide.pdf')
#env.Alias('guide_pdf', tmp)

#env.Command(env['prefix']+'/release/doc/user/guide.pdf',tex,
            #[ mytest(), "latex %s guide.tex"%latexmode,  \
              #"bibtex guide",                  \
              #"makeindex guide",               \
              #"latex %s guide"%latexmode,      \
              #"latex %s guide"%latexmode,      \
              #"dvipdf guide.dvi %s"%env['prefix']+'/release/doc/user/guide.pdf' ],
            #chdir=tex_dir)
#env.Alias('guide_pdf', env['prefix']+'/release/doc/user/guide.pdf')

local_env.Command(env['prefix']+'/release/doc/user/html/index.htm', tex, \
                [dir_cmd+"latex2html -top_navigation \
                        -bottom_navigation \
                        -index_in_navigation \
                        -contents_in_navigation \
                        -next_page_in_navigation \
                        -previous_page_in_navigation \
                        -title \"esys users guide\" \
                        -noshow_section_numbers \
                        -dir \"../../release/doc/user/html\" -mkdir \
                        -address \"esys@esscc.uq.edu.au\" \
                        -antialias_text -antialias -transparent \
                        -noshort_extn \
                        -up_url \"https://launchpad.net/escript-finley\", \
                        -up_title \"escript\" guide.tex"])
env.Alias('guide_html', env['prefix']+'/release/doc/user/html/index.htm')

