# $Id$
"""checks the contact mesh generator for a single element by comparing the generated mesh file with a reference"""
import sys
import os
import unittest
                                                                                                                                                          
esys_root=os.getenv('ESYS_ROOT')
sys.path.append(esys_root+'/finley/lib')
sys.path.append(esys_root+'/escript/lib')
sys.path.append(esys_root+'/escript/py_src')
                                                                                                                                                          
from escript import *
from util import *
from linearPDE import *

import finley
import math
TMPFILE="tmp.msh"
numElm=1

Contact_2D_order1="""+Rectangular 2 x 2 mesh+Rectangular 2 x 2 mesh
2D-Nodes 8
0 0 11 0.000000000000000e+00 0.000000000000000e+00
1 1 12 1.000000000000000e+00 0.000000000000000e+00
2 2 21 0.000000000000000e+00 5.000000000000000e-01
3 3 22 1.000000000000000e+00 5.000000000000000e-01
4 4 11 0.000000000000000e+00 5.000000000000000e-01
5 5 12 1.000000000000000e+00 5.000000000000000e-01
6 6 21 0.000000000000000e+00 1.000000000000000e+00
7 7 22 1.000000000000000e+00 1.000000000000000e+00
Rec4 2
0 0 0 1 3 2
5 0 4 5 7 6
Line2 6
1 10 0 1
3 1 2 0
4 2 1 3
8 1 6 4
9 2 5 7
7 20 7 6
Line2_Contact 1
2 10 3 2 5 4
Point1 0
"""

Contact_2D_order1_onFace="""+Rectangular 2 x 2 mesh+Rectangular 2 x 2 mesh
2D-Nodes 8
0 0 11 0.000000000000000e+00 0.000000000000000e+00
1 1 12 1.000000000000000e+00 0.000000000000000e+00
2 2 21 0.000000000000000e+00 5.000000000000000e-01
3 3 22 1.000000000000000e+00 5.000000000000000e-01
4 4 11 0.000000000000000e+00 5.000000000000000e-01
5 5 12 1.000000000000000e+00 5.000000000000000e-01
6 6 21 0.000000000000000e+00 1.000000000000000e+00
7 7 22 1.000000000000000e+00 1.000000000000000e+00
Rec4 2
0 0 0 1 3 2
5 0 4 5 7 6
Rec4Face 6
1 10 0 1 3 2
3 1 2 0 1 3
4 2 1 3 2 0
7 20 7 6 4 5
8 1 6 4 5 7
9 2 5 7 6 4
Rec4Face_Contact 1
2 10 3 2 0 1 5 4 6 7
Point1 0
"""

Contact_2D_order2="""+Rectangular 3 x 3 mesh+Rectangular 3 x 3 mesh
2D-Nodes 16
0 0 11 0.000000000000000e+00 0.000000000000000e+00
1 1 10 5.000000000000000e-01 0.000000000000000e+00
2 2 12 1.000000000000000e+00 0.000000000000000e+00
3 3 1 0.000000000000000e+00 2.500000000000000e-01
5 4 2 1.000000000000000e+00 2.500000000000000e-01
6 5 21 0.000000000000000e+00 5.000000000000000e-01
7 6 20 5.000000000000000e-01 5.000000000000000e-01
8 7 22 1.000000000000000e+00 5.000000000000000e-01
9 8 11 0.000000000000000e+00 5.000000000000000e-01
10 9 10 5.000000000000000e-01 5.000000000000000e-01
11 10 12 1.000000000000000e+00 5.000000000000000e-01
12 11 1 0.000000000000000e+00 7.500000000000000e-01
14 12 2 1.000000000000000e+00 7.500000000000000e-01
15 13 21 0.000000000000000e+00 1.000000000000000e+00
16 14 20 5.000000000000000e-01 1.000000000000000e+00
17 15 22 1.000000000000000e+00 1.000000000000000e+00
Rec8 2
0 0 0 2 8 6 1 5 7 3
5 0 9 11 17 15 10 14 16 12
Line3 6
1 10 0 2 1
3 1 6 0 3
4 2 2 8 5
8 1 15 9 12
9 2 11 17 14
7 20 17 15 16
Line3_Contact 1
2 10 8 6 7 11 9 10
Point1 0
"""

Contact_2D_order2_onFace="""+Rectangular 3 x 3 mesh+Rectangular 3 x 3 mesh
2D-Nodes 16
0 0 11 0.000000000000000e+00 0.000000000000000e+00
1 1 10 5.000000000000000e-01 0.000000000000000e+00
2 2 12 1.000000000000000e+00 0.000000000000000e+00
3 3 1 0.000000000000000e+00 2.500000000000000e-01
5 4 2 1.000000000000000e+00 2.500000000000000e-01
6 5 21 0.000000000000000e+00 5.000000000000000e-01
7 6 20 5.000000000000000e-01 5.000000000000000e-01
8 7 22 1.000000000000000e+00 5.000000000000000e-01
9 8 11 0.000000000000000e+00 5.000000000000000e-01
10 9 10 5.000000000000000e-01 5.000000000000000e-01
11 10 12 1.000000000000000e+00 5.000000000000000e-01
12 11 1 0.000000000000000e+00 7.500000000000000e-01
14 12 2 1.000000000000000e+00 7.500000000000000e-01
15 13 21 0.000000000000000e+00 1.000000000000000e+00
16 14 20 5.000000000000000e-01 1.000000000000000e+00
17 15 22 1.000000000000000e+00 1.000000000000000e+00
Rec8 2
0 0 0 2 8 6 1 5 7 3
5 0 9 11 17 15 10 14 16 12
Rec8Face 6
1 10 0 2 8 6 1 5 7 3
3 1 6 0 2 8 3 1 5 7
4 2 2 8 6 0 5 7 3 1
7 20 17 15 9 11 16 12 10 14
8 1 15 9 11 17 12 10 14 16
9 2 11 17 15 9 14 16 12 10
Rec8Face_Contact 1
2 10 8 6 0 2 7 3 1 5 11 9 15 17 10 12 16 14
Point1 0
"""

Contact_3D_order1="""+Rectangular 2 x 2 x 2 mesh+Rectangular 2 x 2 x 2 mesh
3D-Nodes 16
0 0 111 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
1 1 112 1.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
2 2 121 0.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
3 3 122 1.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
4 4 211 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
5 5 212 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
6 6 221 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
7 7 222 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
8 8 111 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
9 9 112 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
10 10 121 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
11 11 122 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
12 12 211 0.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
13 13 212 1.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
14 14 221 0.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
15 15 222 1.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
Hex8 2
0 0 0 1 3 2 4 5 7 6
7 0 8 9 11 10 12 13 15 14
Rec4 10
1 100 0 2 3 1
3 1 0 4 6 2
5 10 0 1 5 4
4 2 1 3 7 5
6 20 2 6 7 3
10 1 8 12 14 10
12 10 8 9 13 12
11 2 9 11 15 13
13 20 10 14 15 11
9 200 12 13 15 14
Rec4_Contact 1
2 100 4 5 7 6 8 9 11 10
Point1 0
"""

Contact_3D_order1_onFace="""+Rectangular 2 x 2 x 2 mesh+Rectangular 2 x 2 x 2 mesh
3D-Nodes 16
0 0 111 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
1 1 112 1.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
2 2 121 0.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
3 3 122 1.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
4 4 211 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
5 5 212 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
6 6 221 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
7 7 222 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
8 8 111 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
9 9 112 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
10 10 121 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
11 11 122 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
12 12 211 0.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
13 13 212 1.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
14 14 221 0.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
15 15 222 1.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
Hex8 2
0 0 0 1 3 2 4 5 7 6
7 0 8 9 11 10 12 13 15 14
Hex8Face 10
1 100 0 2 3 1 4 6 7 5
3 1 0 4 6 2 1 5 7 3
4 2 1 3 7 5 0 2 6 4
5 10 0 1 5 4 2 3 7 6
6 20 2 6 7 3 0 4 5 1
9 200 12 13 15 14 8 9 11 10
10 1 8 12 14 10 9 13 15 11
11 2 9 11 15 13 8 10 14 12
12 10 8 9 13 12 10 11 15 14
13 20 10 14 15 11 8 12 13 9
Hex8Face_Contact 1
2 100 4 5 7 6 0 1 3 2 8 9 11 10 12 13 15 14
Point1 0
"""

Contact_3D_order2="""+Rectangular 3 x 3 x 3 mesh+Rectangular 3 x 3 x 3 mesh
3D-Nodes 40
0 0 111 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
1 1 110 5.000000000000000e-01 0.000000000000000e+00 0.000000000000000e+00
2 2 112 1.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
3 3 101 0.000000000000000e+00 5.000000000000000e-01 0.000000000000000e+00
5 4 102 1.000000000000000e+00 5.000000000000000e-01 0.000000000000000e+00
6 5 121 0.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
7 6 120 5.000000000000000e-01 1.000000000000000e+00 0.000000000000000e+00
8 7 122 1.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
9 8 11 0.000000000000000e+00 0.000000000000000e+00 2.500000000000000e-01
11 9 12 1.000000000000000e+00 0.000000000000000e+00 2.500000000000000e-01
15 10 21 0.000000000000000e+00 1.000000000000000e+00 2.500000000000000e-01
17 11 22 1.000000000000000e+00 1.000000000000000e+00 2.500000000000000e-01
18 12 211 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
19 13 210 5.000000000000000e-01 0.000000000000000e+00 5.000000000000000e-01
20 14 212 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
21 15 201 0.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
23 16 202 1.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
24 17 221 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
25 18 220 5.000000000000000e-01 1.000000000000000e+00 5.000000000000000e-01
26 19 222 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
27 20 111 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
28 21 110 5.000000000000000e-01 0.000000000000000e+00 5.000000000000000e-01
29 22 112 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
30 23 101 0.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
32 24 102 1.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
33 25 121 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
34 26 120 5.000000000000000e-01 1.000000000000000e+00 5.000000000000000e-01
35 27 122 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
36 28 11 0.000000000000000e+00 0.000000000000000e+00 7.500000000000000e-01
38 29 12 1.000000000000000e+00 0.000000000000000e+00 7.500000000000000e-01
42 30 21 0.000000000000000e+00 1.000000000000000e+00 7.500000000000000e-01
44 31 22 1.000000000000000e+00 1.000000000000000e+00 7.500000000000000e-01
45 32 211 0.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
46 33 210 5.000000000000000e-01 0.000000000000000e+00 1.000000000000000e+00
47 34 212 1.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
48 35 201 0.000000000000000e+00 5.000000000000000e-01 1.000000000000000e+00
50 36 202 1.000000000000000e+00 5.000000000000000e-01 1.000000000000000e+00
51 37 221 0.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
52 38 220 5.000000000000000e-01 1.000000000000000e+00 1.000000000000000e+00
53 39 222 1.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
Hex20 2
0 0 0 2 8 6 18 20 26 24 1 5 7 3 9 11 17 15 19 23 25 21
7 0 27 29 35 33 45 47 53 51 28 32 34 30 36 38 44 42 46 50 52 48
Rec8 10
1 100 0 6 8 2 3 7 5 1
3 1 0 18 24 6 9 21 15 3
5 10 0 2 20 18 1 11 19 9
4 2 2 8 26 20 5 17 23 11
6 20 6 24 26 8 15 25 17 7
10 1 27 45 51 33 36 48 42 30
12 10 27 29 47 45 28 38 46 36
11 2 29 35 53 47 32 44 50 38
13 20 33 51 53 35 42 52 44 34
9 200 45 47 53 51 46 50 52 48
Rec8_Contact 1
2 100 18 20 26 24 19 23 25 21 27 29 35 33 28 32 34 30
Point1 0
"""

Contact_3D_order2_onFace="""+Rectangular 3 x 3 x 3 mesh+Rectangular 3 x 3 x 3 mesh
3D-Nodes 40
0 0 111 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
1 1 110 5.000000000000000e-01 0.000000000000000e+00 0.000000000000000e+00
2 2 112 1.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00
3 3 101 0.000000000000000e+00 5.000000000000000e-01 0.000000000000000e+00
5 4 102 1.000000000000000e+00 5.000000000000000e-01 0.000000000000000e+00
6 5 121 0.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
7 6 120 5.000000000000000e-01 1.000000000000000e+00 0.000000000000000e+00
8 7 122 1.000000000000000e+00 1.000000000000000e+00 0.000000000000000e+00
9 8 11 0.000000000000000e+00 0.000000000000000e+00 2.500000000000000e-01
11 9 12 1.000000000000000e+00 0.000000000000000e+00 2.500000000000000e-01
15 10 21 0.000000000000000e+00 1.000000000000000e+00 2.500000000000000e-01
17 11 22 1.000000000000000e+00 1.000000000000000e+00 2.500000000000000e-01
18 12 211 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
19 13 210 5.000000000000000e-01 0.000000000000000e+00 5.000000000000000e-01
20 14 212 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
21 15 201 0.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
23 16 202 1.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
24 17 221 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
25 18 220 5.000000000000000e-01 1.000000000000000e+00 5.000000000000000e-01
26 19 222 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
27 20 111 0.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
28 21 110 5.000000000000000e-01 0.000000000000000e+00 5.000000000000000e-01
29 22 112 1.000000000000000e+00 0.000000000000000e+00 5.000000000000000e-01
30 23 101 0.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
32 24 102 1.000000000000000e+00 5.000000000000000e-01 5.000000000000000e-01
33 25 121 0.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
34 26 120 5.000000000000000e-01 1.000000000000000e+00 5.000000000000000e-01
35 27 122 1.000000000000000e+00 1.000000000000000e+00 5.000000000000000e-01
36 28 11 0.000000000000000e+00 0.000000000000000e+00 7.500000000000000e-01
38 29 12 1.000000000000000e+00 0.000000000000000e+00 7.500000000000000e-01
42 30 21 0.000000000000000e+00 1.000000000000000e+00 7.500000000000000e-01
44 31 22 1.000000000000000e+00 1.000000000000000e+00 7.500000000000000e-01
45 32 211 0.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
46 33 210 5.000000000000000e-01 0.000000000000000e+00 1.000000000000000e+00
47 34 212 1.000000000000000e+00 0.000000000000000e+00 1.000000000000000e+00
48 35 201 0.000000000000000e+00 5.000000000000000e-01 1.000000000000000e+00
50 36 202 1.000000000000000e+00 5.000000000000000e-01 1.000000000000000e+00
51 37 221 0.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
52 38 220 5.000000000000000e-01 1.000000000000000e+00 1.000000000000000e+00
53 39 222 1.000000000000000e+00 1.000000000000000e+00 1.000000000000000e+00
Hex20 2
0 0 0 2 8 6 18 20 26 24 1 5 7 3 9 11 17 15 19 23 25 21
7 0 27 29 35 33 45 47 53 51 28 32 34 30 36 38 44 42 46 50 52 48
Hex20Face 10
1 100 0 6 8 2 18 24 26 20 3 7 5 1 9 15 17 11 21 25 23 19
3 1 0 18 24 6 2 20 26 8 9 21 15 3 1 19 25 7 11 23 17 5
4 2 2 8 26 20 0 6 24 18 5 17 23 11 1 7 25 19 3 15 21 9
5 10 0 2 20 18 6 8 26 24 1 11 19 9 3 5 23 21 7 17 25 15
6 20 6 24 26 8 0 18 20 2 15 25 17 7 3 21 23 5 9 19 11 1
9 200 45 47 53 51 27 29 35 33 46 50 52 48 36 38 44 42 28 32 34 30
10 1 27 45 51 33 29 47 53 35 36 48 42 30 28 46 52 34 38 50 44 32
11 2 29 35 53 47 27 33 51 45 32 44 50 38 28 34 52 46 30 42 48 36
12 10 27 29 47 45 33 35 53 51 28 38 46 36 30 32 50 48 34 44 52 42
13 20 33 51 53 35 27 45 47 29 42 52 44 34 30 48 50 32 36 46 38 28
Hex20Face_Contact 1
2 100 18 20 26 24 0 2 8 6 19 23 25 21 9 11 17 15 1 5 7 3 27 29 35 33 45 47 53 51 28 32 34 30 36 38 44 42 46 50 52 48
Point1 0
"""

def checker(dom,reference):
   dom.write(TMPFILE)
   if reference != open(TMPFILE).read():
      return None
   else:
      return not None

def mkMesh(dim,order,onElem):
    if dim==2:
         ms1=finley.Rectangle(numElm,numElm,order,l1=0.5,useElementsOnFace=onElem)
         ms2=finley.Rectangle(numElm,numElm,order,l1=0.5,useElementsOnFace=onElem)
         ms2.setX(ms2.getX()+[0,0.5])
    else:
         ms1=finley.Brick(numElm,numElm,numElm,order,l2=0.5,useElementsOnFace=onElem)
         ms2=finley.Brick(numElm,numElm,numElm,order,l2=0.5,useElementsOnFace=onElem)
         ms2.setX(ms2.getX()+[0,0,0.5])
    return finley.JoinFaces([ms1,ms2])

failed=[]

case="Contact: 2D, order 1"
my_dom=mkMesh(2,1,FALSE)
if checker(my_dom,Contact_2D_order1):
  print case," passed."
else:
  failed.append(case)

case="Contact: 2D, order 1,elements on face"
my_dom=mkMesh(2,1,TRUE)
if checker(my_dom,Contact_2D_order1_onFace):
  print case," passed."
else:
  failed.append(case)

case="Contact: 2D, order 2"
my_dom=mkMesh(2,2,FALSE)
if checker(my_dom,Contact_2D_order2):
  print case," passed."
else:
  failed.append(case)

case="Contact: 2D, order 2,elements on face"
my_dom=mkMesh(2,2,TRUE)
if checker(my_dom,Contact_2D_order2_onFace):
  print case," passed."
else:
  failed.append(case)

case="Contact: 3D, order 1"
my_dom=mkMesh(3,1,FALSE)
if checker(my_dom,Contact_3D_order1):
  print case," passed."
else:
  failed.append(case)

case="Contact: 3D, order 1,elements on face"
my_dom=mkMesh(3,1,TRUE)
if checker(my_dom,Contact_3D_order1_onFace):
  print case," passed."
else:
  failed.append(case)

case="Contact: 3D, order 2"
my_dom=mkMesh(3,2,FALSE)
if checker(my_dom,Contact_3D_order2):
  print case," passed."
else:
  failed.append(case)

case="Contact: 3D, order 2,elements on face"
my_dom=mkMesh(3,2,TRUE)
if checker(my_dom,Contact_3D_order2_onFace):
  print case," passed."
else:
  failed.append(case)

if len(failed) == 0:
   print "@@ contact mesh generation test passed"
else:
   print "@@ contact mesh generation failed for %s"%failed
