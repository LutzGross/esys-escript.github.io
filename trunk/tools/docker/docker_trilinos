FROM debian:stretch-slim

WORKDIR /app
COPY . /app

RUN echo deb http://deb.debian.org/debian stretch-backports main >> /etc/apt/sources.list
RUN apt-get update
RUN apt-get -t stretch-backports install -y cmake
RUN apt-get install -y gmsh git g++ python3 python3-dev python3-numpy python3-sympy python3-matplotlib python3-scipy python3-pyproj python3-gdal libboost-python-dev libboost-random-dev libboost-iostreams-dev libnetcdf-dev libnetcdf-cxx-legacy-dev libnetcdf-c++4-dev libopenmpi-dev libsilo-dev libsuitesparse-dev scons subversion lsb-release 
RUN mkdir /app/trilinos_source
RUN git clone https://github.com/trilinos/Trilinos /app/trilinos_source
RUN mkdir /app/trilinos_build
RUN cd /app/trilinos_build
RUN cmake -D CMAKE_CXX_COMPILER=`which g++` -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_VERBOSE_MAKEFILE=FALSE -D CMAKE_C_FLAGS=' -O3 -funroll-loops -fPIC -fopenmp ' -D CMAKE_CXX_FLAGS=' -O3 -funroll-loops -fPIC -fopenmp ' -D CMAKE_Fortran_FLAGS=' -O3 -fPIC -fopenmp' -D CMAKE_INSTALL_PREFIX=/app/trilinos/ -D Trilinos_ENABLE_CXX11=ON -D Trilinos_ENABLE_Fortran=OFF -D BUILD_SHARED_LIBS=ON -D TPL_ENABLE_BLAS=ON -D TPL_ENABLE_LAPACK=ON -D TPL_ENABLE_Boost=ON -D TPL_ENABLE_METIS=OFF -D TPL_ENABLE_UMFPACK=ON -D TPL_UMFPACK_INCLUDE_DIRS=/usr/include/suitesparse -D Trilinos_ENABLE_Amesos2=ON -D Trilinos_ENABLE_Belos=ON -D Trilinos_ENABLE_Ifpack2=ON -D Trilinos_ENABLE_Kokkos=ON -D Trilinos_ENABLE_MueLu=ON -D Trilinos_ENABLE_Teuchos=ON -D Trilinos_ENABLE_Tpetra=ON -D Trilinos_ENABLE_EXPLICIT_INSTANTIATION=ON -D Trilinos_ENABLE_COMPLEX=ON -D Trilinos_ENABLE_OpenMP=ON -D Trilinos_ENABLE_ALL_OPTIONAL_PACKAGES=OFF -D BUILD_SHARED_LIBS=ON /app/trilinos_source
RUN make -j`nproc` install
RUN svn co https://svn.geocomp.uq.edu.au/svn/esys13/trunk /app/escript
RUN cd /app/escript && scons options_file=scons/templates/sid_py3_options.py paso=1 umfpack=1 trilinos=1 -j`nproc` prefix=/app/ trilinos_prefix=/app/trilinos/ werror=0

CMD /app/bin/run-escript