FROM debian:stretch-slim

WORKDIR /app
COPY . /app

RUN echo deb http://deb.debian.org/debian stretch-backports main >> /etc/apt/sources.list
RUN echo deb http://deb.debian.org/debian jessie main >> /etc/apt/sources.list
RUN apt-get update
RUN apt-get -t stretch-backports install -y cmake
RUN apt-get -t jessie install -y libsuperlu-dev
RUN apt-get -t stretch install -y gmsh git g++ gfortran python3 python3-dev python3-numpy python3-sympy python3-matplotlib python3-scipy python3-pyproj python3-gdal libboost-python-dev libboost-random-dev libboost-iostreams-dev libnetcdf-dev libnetcdf-cxx-legacy-dev libnetcdf-c++4-dev libmetis-dev libmumps-dev libopenmpi-dev libsilo-dev libscotchparmetis-dev libsuitesparse-dev scons subversion lsb-release
RUN mkdir /app/trilinos_source
RUN git clone https://github.com/trilinos/Trilinos /app/trilinos_source
RUN cd /app/trilinos_source && git reset --hard f94b7be34e20e8ac35a1f475f58231f651a2f5c8
RUN mkdir /app/trilinos_build
RUN cd /app/trilinos_build
RUN cmake -D C_COMPILER=`which g++` -D CXX_COMPILER=`which g++` -D Fortran_COMPILER=`which gfortran` -D CXX_FLAGS="-w -O3 -fdiagnostics-color=always" -D CC_FLAGS="-w -O3 -fdiagnostics-color=always" _D Fortran_FLAGS="-w -O3" -D CMAKE_INSTALL_PREFIX=/app/trilinos/ -D Trilinos_ENABLE_CXX11=ON -D Trilinos_ENABLE_Fortran=ON -D BUILD_SHARED_LIBS=ON -D TPL_ENABLE_BLAS=ON -D TPL_ENABLE_LAPACK=ON -D TPL_ENABLE_Boost=ON -D TPL_ENABLE_Cholmod=ON -D TPL_ENABLE_CppUnit=OFF -D TPL_ENABLE_Matio=OFF -D TPL_ENABLE_METIS=ON -D TPL_ENABLE_MUMPS=ON -D TPL_ENABLE_ParMETIS=OFF -D TPL_ENABLE_Pthread=ON -D TPL_ENABLE_SCALAPACK=ON -D TPL_ENABLE_SuperLU=ON -D TPL_ENABLE_UMFPACK=ON -D TPL_BLAS_INCLUDE_DIRS=/usr/include/suitesparse -D TPL_Cholmod_INCLUDE_DIRS=/usr/include/suitesparse -D TPL_Cholmod_LIBRARIES='/usr/lib/x86_64-linux-gnu/libcholmod.so;/usr/lib/x86_64-linux-gnu/libamd.so;/usr/lib/x86_64-linux-gnu/libcolamd.so' -D TPL_UMFPACK_INCLUDE_DIRS=/usr/include/suitesparse -D TPL_SCALAPACK_LIBRARIES=/usr/lib/libscalapack-openmpi.so -D TPL_SuperLU_INCLUDE_DIRS=/usr/include/superlu -D Trilinos_ENABLE_Amesos=ON -D Trilinos_ENABLE_Amesos2=ON -D Trilinos_ENABLE_Belos=ON -D Trilinos_ENABLE_Ifpack2=ON -D Trilinos_ENABLE_Kokkos=ON -D Trilinos_ENABLE_MueLu=ON -D Trilinos_ENABLE_Teuchos=ON -D Trilinos_ENABLE_Tpetra=ON -D Trilinos_ENABLE_EXPLICIT_INSTANTIATION=ON -D Trilinos_ENABLE_COMPLEX=ON -D Trilinos_ENABLE_OpenMP=ON -D TPL_ENABLE_MPI=ON -D Trilinos_ENABLE_ALL_OPTIONAL_PACKAGES=ON -D KOKKOS_ENABLE_AGGRESSIVE_VECTORIZATION=ON /app/trilinos_source
RUN make -j`nproc` install
RUN rm -rf /app/trilinos_build
RUN rm -rf /app/trilinos_source
RUN svn co https://svn.geocomp.uq.edu.au/svn/esys13/trunk /app/escript
RUN cd /app/escript && scons options_file=scons/templates/stretch_py3_options.py paso=1 umfpack=1 trilinos=1 -j`nproc` prefix=/app/ trilinos_prefix=/app/trilinos/ werror=0 mpi=OPENMPI insane=True
RUN rm -rf /app/escript

CMD /app/bin/run-escript