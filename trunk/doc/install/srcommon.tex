
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Copyright (c) 2003-2008 by University of Queensland
% Earth Systems Science Computational Center (ESSCC)
% http://www.uq.edu.au/esscc
%
% Primary Business: Queensland, Australia
% Licensed under the Open Software License version 3.0
% http://www.opensource.org/licenses/osl-3.0.php
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% This file contains material common to all src distributions.

% The original version of this content came from the esscc twiki page maintained by ksteube

\esfinley is known to compile and run on the following systems:
\begin{itemize}
 \item \linux under gcc\footnote{There are some problems with OpenMP under gcc prior to version 4.3.2} - \Sec{sec:srclinux}
\item \linux under icc on SGI ICE 8200.
\item \macosx under gcc - \Sec{sec:srcmac}
\end{itemize}

\section{External dependencies}
The following external packages are required in order to compile and run \esfinley.
Where version numbers are specified, more recent versions can probably be subsituted.
You can either try the standard/precompiled packages available for your operating system or you can download and build them from source.
The advantage of using existing packages is that they will probably all work togther properly.
You must take greater care if downloading sources separately.

\begin{itemize}
 \item python 2.4.4 (\url{http://python.org}) \\
- Python interpreter (You must compile with shared libraries.)
\item numarray 1.5.2 (\url{http://www.stsci.edu/resources/software_hardware/numarray/numarray.html}) \\
- Arrays for python.
\item boost 1_35_0 (\url{http://www.boost.org}) \\
- Provides an interface between C++ and python.
\item scons 0.989.5 (\url{http://www.scons.org/}) \\
- a python-based alternative to ``make''.
\end{itemize}

The following packages should be sufficient (but not necessarily minimal) for Debian 5.0 (``Lenny''):
python-dev, libboost1.35-dev, scons, python-numarray, g++.


These packages may be required for some of the optional capabilities of the system.

\begin{itemize}
 \item netcdf-3.6.2 (\url{http://www.unidata.ucar.edu/software/netcdf}) \\-
        Used to save data sets in binary form for checkpoint/restart (must be compiled with -fPIC).
\item vtk-5.0.4 (\url{http://www.vtk.org}) \\-
        This is used to save VTK files for visualization.
  \begin{itemize}
  \item cmake-2.4.6 (\url{http://www.cmake.org}) \\-
        This is used to build VTK.
  \item     mesa-7.0.3 (\url{http://www.mesa3d.org})\\-
        Free OpenGL replacement used by VTK.
  \end{itemize}

\item     mpich2-1.0.7 (\url{http://www.mcs.anl.gov/research/projects/mpich2}) \\-
        Parallelization with MPI.
\item     parmetis-3.1 (\url{http://glaros.dtc.umn.edu/gkhome/metis/parmetis/overview}) \\-
        Optimization of the stiffness matrix.
\item MKL (\url{http://www.intel.com/cd/software/products/asmo-na/eng/307757.htm}) \\-
        Intel's Math Kernel Library for use with their c compiler.
\end{itemize}

The following packages might be useful for mesh generation:
\begin{itemize}
 \item gmsh-2.2.0 (\url{http://www.geuz.org/gmsh}) \\-
    Mesh generation and viewing.
  \begin{itemize}
 \item fltk-1.1.9 (\url{http://www.fltk.org}) \\-
    This is used to build gmsh 
\item gsl-1.10 (\url{http://www.gnu.org/software/gsl}) \\-
    This is used to build gmsh 
\end{itemize}

\item triangle-1.6 (\url{http://www.cs.cmu.edu/~quake/triangle.html}) 
\end{itemize}

Packages for visualization:
\begin{itemize}
 \item mayavi-1.5 (\url{http://mayavi.sourceforge.net}) \\-
    MayaVi is referenced in our User Guide for viewing VTK files.
 \item visit-1.9 (\url{https://wci.llnl.gov/codes/visit/})
\end{itemize}

\section{Compilation}
Throughout this section we will assume that the source code is uncompressed in a directory called trunk.
You can call the directory anything you like, provided that you make the change before you compile.

You need to indicate where to find the external dependencies.
Unless specified otherwise, all paths will be relative to the top level of the source.
To do this, create a file in the \filename{scons} directory called \filename{x_options.py} where ``x'' is the name of your computer.
As a starting point use one of the following:
\begin{itemize}
 \item \filename{scons/linux_options_example.py} (\linux desktop)
\item \filename{scons/mac_options_example.py} (\macosx desktop)
\item \filename{ice_options_example.py} (SGI ICE 8200)
\item \filename{winxp_options_example.py} (\winxp)
\end{itemize}

To actually compile (if you have $n$ processors, then you can use \texttt{scons -j$n$} instead):

\begin{shellCode}
cd trunk
scons
\end{shellCode}

As part of its output, scons will tell you the name of the options file it used as well as a list of features 
and whether they are enabled for your build.

If you require debug versions of the libraries, use:
\begin{shellCode}
 scons usedebug=yes
\end{shellCode}
A note about scons: if you recompile later with different options (eg leaving off usedebug), scons will revert 
to its default values. If you wish to make a change more permanent, then modify your options file.


You can install the binaries/libraries in a different location with:
\begin{shellCode}
 scons prefix=some_dir
\end{shellCode}

You can test your build using 
\begin{shellCode}
scons all_tests
\end{shellCode}
An alternative method is available for performing tests on \openmp and MPI builds.

\subsection{Compilation with \openmp}
You will need to consult your compiler documentation for the precise switches to use to enable OpenMP features.
Once you know the options, modify the omp_optim, omp_debug and omp_libs variables in your options.py file.

For example, for gcc compilers which support \openmp use.
\begin{shellCode}
omp_optim		= '-fopenmp'
omp_debug		= '-fopenmp'
omp_libs		= ['gomp']
\end{shellCode}
Depending on your version, last change may not be required.

Then recompile.
\begin{shellCode}
 scons useopenmp=yes
\end{shellCode}

\subsection{Compilation with MPI}
You will need to have MPI installed on your system.
There are a number of implementations so we do not provide any specific advice here.
You will need to modify the following variables in your options file.
\begin{itemize}
 \item \texttt{mpi_path} \\
	where to find \filename{mpi.h}
\item \texttt{mpi_lib_path} \\
	where to find libraries for mpi
\item \texttt{mpi_libs} \\
	which libraries to link to.
\end{itemize}

Then compile with:
\begin{shellCode}
 scons usempi=yes
\end{shellCode}

As with debug and openmp, you can make this a more permanent setting by modifying your options file.

\subsection{Difficulties}

%This is copied from Ken's notes on teh old Twiki page
\subsubsection{``Bad magic number''}
Some reasons for this error message include:
\begin{itemize}
 \item Using different versions of python when installing and running escript (Use \texttt{which python} and \texttt{python --version} to check)
\item Using different versions of libraries (Make sure \texttt{LD_LIBRARY_PATH} has \filename{/trunk/lib} listed first)
\item Using different versions of python modules (Make sure \texttt{PYTHONPATH} has \filename{/trunk/escript} directory listed first) 
\end{itemize}

Another error we sometimes see is unsatisfied externals when trying to run a python script. This is usually due to not having \texttt{LD_LIBRARY_PATH} and \texttt{PYTHONPATH} set correctly so that you run with different libraries from the ones the code was compiled against. Check which libraries you are running against with \texttt{ldd lib/libfinley.so} and \texttt{ldd esys/finley/finleycpp.so}.

It is also possible that the person who compiled \esfinley used incompatible libraries. For example, if you run with Python2.4 but the software was compiled against Python2.5 then you will get unsatisfied externals or a large error message with a long traceback. Another case is when Boost or Numarray was compiled against the wrong Python library. To avoid these problems everyone (builder and user) must make certain they are using the same python libraries. 
