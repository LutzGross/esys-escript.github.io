
########################################################
#
# Copyright (c) 2003-2010 by University of Queensland
# Earth Systems Science Computational Center (ESSCC)
# http://www.uq.edu.au/esscc
#
# Primary Business: Queensland, Australia
# Licensed under the Open Software License version 3.0
# http://www.opensource.org/licenses/osl-3.0.php
#
########################################################

from os.path import splitext
Import('*')

local_env = env.Clone()

#  files defining test runs (passing in a release)
testruns = []
testruns += ['run_camera.py']
testruns += ['run_carpet.py']
testruns += ['run_carpet_with_lazy_evaluation.py']
testruns += ['run_contour.py']
testruns += ['run_contour_with_lazy_evaluation.py']
testruns += ['run_datacollector.py']
testruns += ['run_ellipsoid.py']
testruns += ['run_ellipsoid_with_lazy_evaluation.py']
testruns += ['run_escript_with_lazy_evaluation.py']
testruns += ['run_exporter.py']
testruns += ['run_image.py']
testruns += ['run_image_with_lazy_evaluation.py']
testruns += ['run_legend.py']
testruns += ['run_legend_with_lazy_evaluation.py']
testruns += ['run_light.py']
testruns += ['run_logo.py']
testruns += ['run_logo_with_lazy_evaluation.py']
testruns += ['run_map.py']
testruns += ['run_map_with_lazy_evaluation.py']
testruns += ['run_movie_with_lazy_evaluation.py']
testruns += ['run_rectangle.py']
testruns += ['run_scene.py']
testruns += ['run_streamline.py']
testruns += ['run_streamline_with_lazy_evaluation.py']
testruns += ['run_text.py']
testruns += ['run_velocity.py']
testruns += ['run_velocity_with_lazy_evaluation.py']

# files defining tests run locally (not as part of a release)
localtestruns = [x for x in Glob('*.py', strings=True) if not x.startswith('run_')]

# all tests
alltestruns = testruns + localtestruns

# test files are just compiled - none of these in pyvisi
#sources = Glob('test_*.py')
#test_pyc = env.PyCompile(sources)
#env.Alias('build_py_tests', test_pyc)

# only run tests if pyvisi enabled
if env['pyvisi']:
    # add unit test to target alias
    local_env.PrependENVPath('PYTHONPATH',str(env.Dir('#/build/$PLATFORM/pyvisi/test/python')))
    local_env['ENV']['PYVISI_TEST_DATA_ROOT']=env.Dir('#/pyvisi/test/python').srcnode().abspath
    local_env['ENV']['PYVISI_WORKDIR']=env.Dir('#/build/$PLATFORM/pyvisi/test/python').srcnode().abspath

    env.Alias('local_py_tests',[splitext(x)[0]+'.passed' for x in alltestruns])
    env.Alias('py_tests', [splitext(x)[0]+'.passed' for x in testruns])
    program = local_env.RunPyUnitTest(alltestruns)
    Depends(program, 'build_py_tests')

    from grouptest import *
    tgroup=GroupTest("$PYTHONRUNNER ",(("PYVISI_TEST_DATA_ROOT","$BATCH_ROOT/pyvisi/test/python"),("PYVISI_WORKDIR","$BUILD_DIR/pyvisi/test/python")),"$BUILD_DIR/pyvisi/test/python","$BATCH_ROOT/pyvisi/test/python",testruns)
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/camera')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/carpet')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/contour')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/ellipsoid')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/escript')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/exporter')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/image')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/legend')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/light')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/logo')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/map')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/movie')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/rectangle')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/scene')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/streamline')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/text')
    tgroup.makeDir('$BUILD_DIR/pyvisi/test/python/data_sample_images/velocity')
    TestGroups.append(tgroup)

